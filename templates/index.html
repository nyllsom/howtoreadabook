<!DOCTYPE html>
<html lang="zh">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Mercurial RAG Console</title>
    <script src="https://cdn.tailwindcss.com"></script>

    <!-- Markdown -->
    <script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>

    <!-- Code highlight -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.9.0/styles/github-dark.min.css">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.9.0/highlight.min.js"></script>

    <!-- KaTeX (Math) -->
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/katex@0.16.10/dist/katex.min.css">
    <script src="https://cdn.jsdelivr.net/npm/katex@0.16.10/dist/katex.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/katex@0.16.10/dist/contrib/auto-render.min.js"></script>

    <style>
        :root {
            --glass-bg: rgba(15, 23, 42, 0.6);
            --glass-border: rgba(148, 163, 184, 0.15);
            --glow-blue: rgba(56, 189, 248, 0.4);
            --glow-purple: rgba(168, 85, 247, 0.3);
        }

        * {
            box-sizing: border-box;
        }

        body {
            min-height: 100vh;
            overflow-x: hidden;
            background: #0a0f1a;
        }

        /* === THREE-LAYER BACKGROUND === */
        .bg-layers {
            position: fixed;
            inset: 0;
            z-index: 0;
            overflow: hidden;
        }

        /* Layer 1: Deep gradient */
        .bg-gradient-base {
            position: absolute;
            inset: 0;
            background: 
                radial-gradient(ellipse 80% 60% at 20% 30%, rgba(30, 58, 138, 0.5) 0%, transparent 60%),
                radial-gradient(ellipse 70% 50% at 80% 70%, rgba(88, 28, 135, 0.4) 0%, transparent 50%),
                linear-gradient(160deg, #0a0f1a 0%, #1e1b4b 40%, #0f172a 70%, #020617 100%);
        }

        /* Layer 2: Liquid metal/silk shapes */
        .liquid-shape {
            position: absolute;
            border-radius: 50%;
            filter: blur(80px);
            opacity: 0.5;
            will-change: transform, opacity;
        }

        .liquid-1 {
            width: 600px;
            height: 400px;
            top: -10%;
            left: 30%;
            background: linear-gradient(135deg, rgba(56, 189, 248, 0.3) 0%, rgba(168, 85, 247, 0.2) 50%, rgba(217, 119, 6, 0.15) 100%);
            animation: drift1 25s ease-in-out infinite;
        }

        .liquid-2 {
            width: 500px;
            height: 350px;
            bottom: 10%;
            right: -5%;
            background: linear-gradient(225deg, rgba(139, 92, 246, 0.35) 0%, rgba(59, 130, 246, 0.2) 60%, rgba(6, 182, 212, 0.15) 100%);
            animation: drift2 30s ease-in-out infinite;
        }

        .liquid-3 {
            width: 400px;
            height: 300px;
            top: 50%;
            left: -5%;
            background: linear-gradient(45deg, rgba(217, 119, 6, 0.2) 0%, rgba(168, 85, 247, 0.25) 50%, rgba(56, 189, 248, 0.15) 100%);
            animation: drift3 20s ease-in-out infinite;
        }

        @keyframes drift1 {
            0%, 100% { transform: translate(0, 0) scale(1) rotate(0deg); opacity: 0.5; }
            25% { transform: translate(50px, 30px) scale(1.1) rotate(5deg); opacity: 0.6; }
            50% { transform: translate(-30px, 60px) scale(0.95) rotate(-3deg); opacity: 0.45; }
            75% { transform: translate(20px, -20px) scale(1.05) rotate(2deg); opacity: 0.55; }
        }

        @keyframes drift2 {
            0%, 100% { transform: translate(0, 0) scale(1) rotate(0deg); opacity: 0.45; }
            33% { transform: translate(-40px, -50px) scale(1.08) rotate(-4deg); opacity: 0.55; }
            66% { transform: translate(30px, 20px) scale(0.92) rotate(3deg); opacity: 0.4; }
        }

        @keyframes drift3 {
            0%, 100% { transform: translate(0, 0) scale(1); opacity: 0.4; }
            50% { transform: translate(60px, -40px) scale(1.15); opacity: 0.5; }
        }

        /* Layer 3: Noise texture */
        .noise-overlay {
            position: absolute;
            inset: 0;
            opacity: 0.03;
            background-image: url("data:image/svg+xml,%3Csvg viewBox='0 0 256 256' xmlns='http://www.w3.org/2000/svg'%3E%3Cfilter id='noise'%3E%3CfeTurbulence type='fractalNoise' baseFrequency='0.9' numOctaves='4' stitchTiles='stitch'/%3E%3C/filter%3E%3Crect width='100%25' height='100%25' filter='url(%23noise)'/%3E%3C/svg%3E");
            background-repeat: repeat;
            pointer-events: none;
        }

        /* === GLASS MORPHISM === */
        .glass-panel {
            background: var(--glass-bg);
            backdrop-filter: blur(20px);
            -webkit-backdrop-filter: blur(20px);
            border: 1px solid var(--glass-border);
            border-radius: 20px;
            box-shadow: 
                0 8px 32px rgba(0, 0, 0, 0.3),
                inset 0 1px 0 rgba(255, 255, 255, 0.05);
        }

        .glass-panel-sm {
            background: rgba(15, 23, 42, 0.5);
            backdrop-filter: blur(16px);
            -webkit-backdrop-filter: blur(16px);
            border: 1px solid var(--glass-border);
            border-radius: 16px;
            box-shadow: 
                0 4px 16px rgba(0, 0, 0, 0.2),
                inset 0 1px 0 rgba(255, 255, 255, 0.03);
        }

        .glass-header {
            background: rgba(10, 15, 26, 0.7);
            backdrop-filter: blur(24px);
            -webkit-backdrop-filter: blur(24px);
            border-bottom: 1px solid rgba(148, 163, 184, 0.1);
            box-shadow: 0 4px 24px rgba(0, 0, 0, 0.2);
        }

        /* === NEON GLOW EFFECTS === */
        .glow-btn {
            position: relative;
            transition: all 0.3s ease;
        }

        .glow-btn:hover {
            box-shadow: 0 0 20px var(--glow-blue), 0 0 40px rgba(56, 189, 248, 0.15);
        }

        .glow-btn:focus {
            outline: none;
            box-shadow: 0 0 0 2px rgba(56, 189, 248, 0.3), 0 0 20px var(--glow-blue);
        }

        .btn-active {
            background: linear-gradient(135deg, rgba(56, 189, 248, 0.2) 0%, rgba(139, 92, 246, 0.15) 100%) !important;
            border-color: rgba(56, 189, 248, 0.5) !important;
            box-shadow: 0 0 20px rgba(56, 189, 248, 0.25), inset 0 1px 0 rgba(255, 255, 255, 0.1);
        }

        .input-glow:focus {
            border-color: rgba(56, 189, 248, 0.5);
            box-shadow: 0 0 0 3px rgba(56, 189, 248, 0.1), 0 0 20px rgba(56, 189, 248, 0.1);
        }

        /* === CHAT STYLES === */
        .chat-container {
            height: calc(100vh - 340px);
            min-height: 300px;
        }

        .user-msg {
            background: linear-gradient(135deg, rgba(51, 65, 85, 0.6) 0%, rgba(30, 41, 59, 0.5) 100%);
            border: 1px solid rgba(148, 163, 184, 0.1);
        }

        .ai-msg {
            background: linear-gradient(135deg, rgba(15, 23, 42, 0.7) 0%, rgba(30, 27, 75, 0.4) 100%);
            border: 1px solid rgba(139, 92, 246, 0.15);
        }

        .markdown-body pre {
            background: rgba(0, 0, 0, 0.4);
            padding: 1rem;
            border-radius: 12px;
            margin: 1rem 0;
            overflow-x: auto;
            border: 1px solid rgba(148, 163, 184, 0.1);
        }

        .markdown-body p { overflow-wrap: anywhere; }

        /* === TYPOGRAPHY === */
        .tiny { font-size: 12px; }

        .gradient-text {
            background: linear-gradient(135deg, #38bdf8 0%, #a78bfa 50%, #f472b6 100%);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
        }

        /* === KATEX === */
        .katex { font-size: 1.05em; max-width: 100%; display: inline-block; overflow-x: auto; overflow-y: hidden; }
        .katex-display { overflow-x: auto; overflow-y: hidden; padding: 0.5rem 0; }

        /* === SCROLLBAR === */
        ::-webkit-scrollbar {
            width: 6px;
            height: 6px;
        }
        ::-webkit-scrollbar-track {
            background: rgba(15, 23, 42, 0.5);
            border-radius: 3px;
        }
        ::-webkit-scrollbar-thumb {
            background: rgba(148, 163, 184, 0.3);
            border-radius: 3px;
        }
        ::-webkit-scrollbar-thumb:hover {
            background: rgba(148, 163, 184, 0.5);
        }

        /* === FORM ELEMENTS === */
        .form-input {
            background: rgba(15, 23, 42, 0.6);
            border: 1px solid rgba(148, 163, 184, 0.15);
            border-radius: 10px;
            transition: all 0.2s ease;
        }

        .form-input:focus {
            outline: none;
            border-color: rgba(56, 189, 248, 0.4);
            box-shadow: 0 0 0 3px rgba(56, 189, 248, 0.1);
        }

        .form-input::placeholder {
            color: rgba(148, 163, 184, 0.5);
        }

        /* === STATUS DOT === */
        .status-dot {
            width: 8px;
            height: 8px;
            border-radius: 50%;
            animation: pulse-glow 2s ease-in-out infinite;
        }

        @keyframes pulse-glow {
            0%, 100% { box-shadow: 0 0 4px currentColor; }
            50% { box-shadow: 0 0 12px currentColor, 0 0 20px currentColor; }
        }
    </style>
</head>
<body class="text-slate-100 font-sans antialiased">
    <!-- Three-layer animated background -->
    <div class="bg-layers">
        <div class="bg-gradient-base"></div>
        <div class="liquid-shape liquid-1"></div>
        <div class="liquid-shape liquid-2"></div>
        <div class="liquid-shape liquid-3"></div>
        <div class="noise-overlay"></div>
    </div>

    <!-- Main content wrapper -->
    <div class="relative z-10 min-h-screen flex flex-col">
        <!-- Floating Glass Header -->
        <header class="glass-header sticky top-0 z-50 px-6 py-4">
            <div class="max-w-7xl mx-auto flex flex-col md:flex-row md:justify-between md:items-center gap-3">
                <div class="flex items-center gap-4">
                    <div class="w-10 h-10 rounded-xl bg-gradient-to-br from-sky-400 to-violet-500 flex items-center justify-center shadow-lg">
                        <svg class="w-6 h-6 text-white" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 10V3L4 14h7v7l9-11h-7z"/>
                        </svg>
                    </div>
                    <div>
                        <h1 class="text-xl font-semibold">
                            <span class="gradient-text">Mercurial</span>
                            <span class="text-slate-400 text-sm font-normal ml-2">RAG Console</span>
                        </h1>
                        <p class="tiny text-slate-500 mt-0.5">智能知识检索 · 个性化响应 · 精准引用</p>
                    </div>
                </div>
                <div id="status-tag" class="flex items-center gap-2 px-4 py-2 rounded-full bg-slate-800/50 border border-slate-700/50">
                    <span class="status-dot bg-emerald-400 text-emerald-400"></span>
                    <span class="text-emerald-400 text-xs font-medium">在线</span>
                    <span class="text-slate-500 text-xs">|</span>
                    <span class="text-slate-300 text-xs">模式: <span id="current-mode-display" class="font-semibold text-sky-400">普通对话</span></span>
                </div>
            </div>
        </header>

        <!-- Main Content -->
        <main class="flex-1 px-4 md:px-6 py-6">
            <div class="max-w-7xl mx-auto">
                <div class="grid grid-cols-1 lg:grid-cols-12 gap-6">
                    
                    <!-- Left Sidebar: Knowledge Base + Personalization -->
                    <aside class="lg:col-span-4 xl:col-span-3 space-y-5">
                        <!-- Knowledge Base Panel -->
                        <div class="glass-panel p-5">
                            <div class="flex items-center justify-between mb-4">
                                <div class="flex items-center gap-2">
                                    <div class="w-8 h-8 rounded-lg bg-gradient-to-br from-sky-500/20 to-violet-500/20 flex items-center justify-center">
                                        <svg class="w-4 h-4 text-sky-400" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 11H5m14 0a2 2 0 012 2v6a2 2 0 01-2 2H5a2 2 0 01-2-2v-6a2 2 0 012-2m14 0V9a2 2 0 00-2-2M5 11V9a2 2 0 012-2m0 0V5a2 2 0 012-2h6a2 2 0 012 2v2M7 7h10"/>
                                        </svg>
                                    </div>
                                    <span class="font-semibold text-slate-200">知识库</span>
                                </div>
                                <div class="px-2 py-1 rounded-md bg-slate-800/60 border border-slate-700/50">
                                    <span class="tiny text-slate-400">向量: </span>
                                    <span id="vec-count" class="tiny text-sky-400 font-semibold">0</span>
                                </div>
                            </div>

                            <form id="uploadForm" class="space-y-3">
                                <div class="flex gap-2">
                                    <input
                                        id="kbFile"
                                        type="file"
                                        name="file"
                                        accept=".pdf,.docx"
                                        class="flex-1 text-sm text-slate-300 file:mr-2 file:py-2 file:px-3 file:rounded-lg file:border-0 file:text-sm file:font-medium file:bg-slate-700/80 file:text-slate-200 hover:file:bg-slate-600 file:cursor-pointer file:transition-colors"
                                    />
                                    <button type="submit" class="glow-btn bg-gradient-to-r from-sky-500 to-violet-500 hover:from-sky-400 hover:to-violet-400 text-white px-4 py-2 rounded-lg text-sm font-medium transition-all">
                                        上传
                                    </button>
                                </div>
                            </form>
                            <div id="uploadStatus" class="tiny text-slate-400 mt-2 min-h-[18px]"></div>

                            <div class="mt-4 pt-4 border-t border-slate-700/50">
                                <div class="flex items-center justify-between">
                                    <label class="flex items-center gap-2 cursor-pointer group">
                                        <input id="ragToggle" type="checkbox" class="w-4 h-4 rounded bg-slate-700 border-slate-600 text-sky-500 focus:ring-sky-500/30 focus:ring-offset-0" checked />
                                        <span class="text-sm text-slate-300 group-hover:text-slate-200 transition-colors">启用 RAG 检索</span>
                                    </label>
                                    <div class="flex items-center gap-2">
                                        <label for="topk" class="tiny text-slate-500">TopK:</label>
                                        <input
                                            id="topk"
                                            type="number"
                                            min="1"
                                            max="12"
                                            value="6"
                                            class="form-input w-14 px-2 py-1 tiny text-center text-slate-200"
                                        >
                                    </div>
                                </div>
                            </div>

                            <div class="mt-4">
                                <div class="tiny text-slate-500 mb-2">已上传文件</div>
                                <div id="docList" class="space-y-2 max-h-40 overflow-auto pr-1">
                                    <div class="tiny text-slate-600">暂无文件</div>
                                </div>
                            </div>
                        </div>

                        <!-- Personalization Panel -->
                        <div class="glass-panel p-5">
                            <div class="flex items-center gap-2 mb-4">
                                <div class="w-8 h-8 rounded-lg bg-gradient-to-br from-violet-500/20 to-pink-500/20 flex items-center justify-center">
                                    <svg class="w-4 h-4 text-violet-400" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9.663 17h4.673M12 3v1m6.364 1.636l-.707.707M21 12h-1M4 12H3m3.343-5.657l-.707-.707m2.828 9.9a5 5 0 117.072 0l-.548.547A3.374 3.374 0 0014 18.469V19a2 2 0 11-4 0v-.531c0-.895-.356-1.754-.988-2.386l-.548-.547z"/>
                                    </svg>
                                </div>
                                <span class="font-semibold text-slate-200">个性化设置</span>
                            </div>

                            <div class="space-y-3">
                                <div class="tiny text-slate-500 mb-1">响应偏好</div>
                                <div class="grid grid-cols-2 gap-2">
                                    <input id="prefLanguage" class="form-input px-3 py-2 tiny text-slate-200" placeholder="语言: zh / en">
                                    <input id="prefTone" class="form-input px-3 py-2 tiny text-slate-200" placeholder="风格: 专业 / 简洁">
                                </div>
                                <textarea id="prefFormat" class="form-input w-full px-3 py-2 tiny text-slate-200 resize-none" rows="2" placeholder="格式提示: 先结论后分点，最后给 next steps"></textarea>
                                <textarea id="prefCite" class="form-input w-full px-3 py-2 tiny text-slate-200 resize-none" rows="2" placeholder="引用风格: 仅在引用存在时输出 [1][2]"></textarea>

                                <div class="pt-3 border-t border-slate-700/50">
                                    <div class="tiny text-slate-500 mb-2">持久记忆</div>
                                    <textarea id="memoryBox" class="form-input w-full px-3 py-2 tiny text-slate-200 resize-none" rows="3" placeholder="例如：我在做一个安全工具项目；偏好用中文；回答要短..."></textarea>
                                </div>

                                <div class="flex gap-2 pt-2">
                                    <button id="savePersonalBtn" class="glow-btn flex-1 bg-emerald-600/80 hover:bg-emerald-500 text-white px-3 py-2 rounded-lg text-sm font-medium transition-all">
                                        保存设置
                                    </button>
                                    <button id="loadPersonalBtn" class="flex-1 bg-slate-700/60 hover:bg-slate-600 text-slate-200 px-3 py-2 rounded-lg text-sm font-medium transition-all border border-slate-600/50">
                                        刷新
                                    </button>
                                </div>
                                <div id="personalStatus" class="tiny text-slate-400 mt-1 min-h-[18px] text-center"></div>
                            </div>
                        </div>
                    </aside>

                    <!-- Right: Main Chat Area -->
                    <section class="lg:col-span-8 xl:col-span-9">
                        <div class="glass-panel p-6 h-full flex flex-col">
                            <!-- Chat Messages -->
                            <div id="chat-box" class="chat-container flex-1 overflow-y-auto mb-4 space-y-4 pr-2">
                                <div class="ai-msg p-5 rounded-2xl">
                                    <div class="flex items-center gap-2 mb-2">
                                        <div class="w-6 h-6 rounded-full bg-gradient-to-br from-sky-400 to-violet-500 flex items-center justify-center">
                                            <svg class="w-3 h-3 text-white" fill="currentColor" viewBox="0 0 20 20">
                                                <path d="M10 2a6 6 0 00-6 6v3.586l-.707.707A1 1 0 004 14h12a1 1 0 00.707-1.707L16 11.586V8a6 6 0 00-6-6z"/>
                                            </svg>
                                        </div>
                                        <span class="text-xs text-slate-500">Mercurial</span>
                                    </div>
                                    <div class="text-slate-200 leading-relaxed">
                                        欢迎使用 <span class="gradient-text font-semibold">Mercurial</span> 智能助手。
                                        <br><br>
                                        上传 PDF/DOCX 文档并启用 RAG 模式，我将基于知识库内容提供带引用的精准回答。当资料不足时，我会清晰标注推理边界并提供下一步建议。
                                    </div>
                                    <div class="tiny text-slate-500 mt-3 pt-3 border-t border-slate-700/30">
                                        提示：这是 Demo 环境，未实现用户隔离，适合本机单人使用。
                                    </div>
                                </div>
                            </div>

                            <!-- Mode Selection & Controls -->
                            <div class="flex flex-wrap gap-2 mb-4">
                                <button id="btn-chat" onclick="setMode('chat')" class="glow-btn glass-panel-sm px-4 py-2.5 rounded-xl text-sm font-medium text-slate-300 hover:text-white transition-all flex items-center gap-2 btn-active">
                                    <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 12h.01M12 12h.01M16 12h.01M21 12c0 4.418-4.03 8-9 8a9.863 9.863 0 01-4.255-.949L3 20l1.395-3.72C3.512 15.042 3 13.574 3 12c0-4.418 4.03-8 9-8s9 3.582 9 8z"/></svg>
                                    普通对话
                                </button>
                                <button id="btn-c" onclick="setMode('c')" class="glow-btn glass-panel-sm px-4 py-2.5 rounded-xl text-sm font-medium text-slate-300 hover:text-white transition-all flex items-center gap-2">
                                    <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M10 20l4-16m4 4l4 4-4 4M6 16l-4-4 4-4"/></svg>
                                    C 语言
                                </button>
                                <button id="btn-python" onclick="setMode('python')" class="glow-btn glass-panel-sm px-4 py-2.5 rounded-xl text-sm font-medium text-slate-300 hover:text-white transition-all flex items-center gap-2">
                                    <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M10 20l4-16m4 4l4 4-4 4M6 16l-4-4 4-4"/></svg>
                                    Python
                                </button>
                                <button id="btn-java" onclick="setMode('java')" class="glow-btn glass-panel-sm px-4 py-2.5 rounded-xl text-sm font-medium text-slate-300 hover:text-white transition-all flex items-center gap-2">
                                    <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M10 20l4-16m4 4l4 4-4 4M6 16l-4-4 4-4"/></svg>
                                    Java
                                </button>

                                <div class="flex-1"></div>

                                <button onclick="clearHistory()" class="glow-btn glass-panel-sm px-4 py-2.5 rounded-xl text-sm font-medium text-slate-400 hover:text-amber-400 hover:border-amber-500/30 transition-all flex items-center gap-2">
                                    <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16"/></svg>
                                    清空
                                </button>
                                <button onclick="quitApp()" class="glow-btn glass-panel-sm px-4 py-2.5 rounded-xl text-sm font-medium text-slate-400 hover:text-red-400 hover:border-red-500/30 transition-all flex items-center gap-2">
                                    <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M17 16l4-4m0 0l-4-4m4 4H7m6 4v1a3 3 0 01-3 3H6a3 3 0 01-3-3V7a3 3 0 013-3h4a3 3 0 013 3v1"/></svg>
                                    退出
                                </button>
                            </div>

                            <!-- Input Area -->
                            <div class="relative">
                                <input type="text" id="user-input"
                                    class="input-glow form-input w-full px-5 py-4 pr-28 text-slate-100 placeholder-slate-500 text-base"
                                    placeholder="输入你的问题..."
                                    onkeyup="if(event.key==='Enter') sendMessage()">
                                <button id="send-btn" onclick="sendMessage()"
                                    class="glow-btn absolute right-2 top-1/2 -translate-y-1/2 bg-gradient-to-r from-sky-500 to-violet-500 hover:from-sky-400 hover:to-violet-400 text-white px-6 py-2.5 rounded-lg text-sm font-medium transition-all">
                                    发送
                                </button>
                            </div>
                            <div class="tiny text-slate-500 mt-3 text-center">
                                RAG 模式下将先检索知识库片段，再生成带引用的回答
                            </div>
                        </div>
                    </section>
                </div>
            </div>
        </main>
    </div>

    <script>
        const chatBox = document.getElementById('chat-box');
        const userInput = document.getElementById('user-input');
        const sendBtn = document.getElementById('send-btn');
        const uploadForm = document.getElementById('uploadForm');
        const uploadStatus = document.getElementById('uploadStatus');
        const docList = document.getElementById('docList');
        const vecCount = document.getElementById('vec-count');

        const ragToggle = document.getElementById('ragToggle');
        const topk = document.getElementById('topk');

        const prefLanguage = document.getElementById('prefLanguage');
        const prefTone = document.getElementById('prefTone');
        const prefFormat = document.getElementById('prefFormat');
        const prefCite = document.getElementById('prefCite');
        const memoryBox = document.getElementById('memoryBox');
        const personalStatus = document.getElementById('personalStatus');

        let currentMode = 'chat';

        function setMode(mode) {
            currentMode = mode;
            updateModeUI();
            const modeNames = { 'chat': '普通对话', 'c': 'C 语言编程', 'python': 'Python 编程', 'java': 'Java 编程' };
            document.getElementById('current-mode-display').innerText = modeNames[mode];
        }

        function updateModeUI() {
            ['btn-chat', 'btn-c', 'btn-python', 'btn-java'].forEach(id => {
                const el = document.getElementById(id);
                if(el) el.classList.remove('btn-active');
            });
            const activeBtn = document.getElementById(`btn-${currentMode}`);
            if(activeBtn) activeBtn.classList.add('btn-active');
        }

        function createMessageElement(role) {
            const div = document.createElement('div');
            div.className = `p-5 rounded-2xl ${role === 'user' ? 'user-msg ml-12' : 'ai-msg mr-4'}`;
            div.innerHTML = `
                <div class="flex items-center gap-2 mb-2">
                    ${role === 'user' 
                        ? '<div class="w-6 h-6 rounded-full bg-slate-600 flex items-center justify-center"><svg class="w-3 h-3 text-slate-300" fill="currentColor" viewBox="0 0 20 20"><path fill-rule="evenodd" d="M10 9a3 3 0 100-6 3 3 0 000 6zm-7 9a7 7 0 1114 0H3z" clip-rule="evenodd"/></svg></div>'
                        : '<div class="w-6 h-6 rounded-full bg-gradient-to-br from-sky-400 to-violet-500 flex items-center justify-center"><svg class="w-3 h-3 text-white" fill="currentColor" viewBox="0 0 20 20"><path d="M10 2a6 6 0 00-6 6v3.586l-.707.707A1 1 0 004 14h12a1 1 0 00.707-1.707L16 11.586V8a6 6 0 00-6-6z"/></svg></div>'
                    }
                    <span class="text-xs text-slate-500">${role === 'user' ? '你' : 'Mercurial'}</span>
                </div>
                <div class="markdown-body text-slate-200 leading-relaxed"></div>
                <div class="file-info mt-4 pt-3 border-t border-slate-700/30 text-sm text-slate-400 hidden"></div>
                <div class="cite-info mt-4 pt-3 border-t border-slate-700/30 text-sm text-slate-300 hidden"></div>
            `;
            chatBox.appendChild(div);
            chatBox.scrollTop = chatBox.scrollHeight;
            return div;
        }

        async function refreshDocs() {
            const r = await fetch('/docs');
            const j = await r.json();
            vecCount.textContent = j.vector_count ?? 0;

            const docs = j.documents || [];
            if (docs.length === 0) {
                docList.innerHTML = '<div class="tiny text-slate-600">暂无上传文件</div>';
                return;
            }
            docList.innerHTML = docs.map(d => `
                <div class="glass-panel-sm px-3 py-2 flex items-center justify-between gap-3">
                    <div class="min-w-0">
                        <div class="text-sm text-slate-200 truncate">${escapeHtml(d.filename)}</div>
                        <div class="tiny text-slate-500">#${d.id} · ${escapeHtml(d.created_at)}</div>
                    </div>
                    <button
                        class="shrink-0 bg-red-500/20 hover:bg-red-500/40 text-red-300 hover:text-red-200 tiny px-2 py-1 rounded-lg transition-colors"
                        onclick="deleteDoc(${d.id}, '${escapeHtml(d.filename)}')"
                        title="删除文件"
                    >
                        <svg class="w-3 h-3" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16"/></svg>
                    </button>
                </div>
            `).join('');
        }

        async function deleteDoc(id, filename) {
            if (!confirm(`确认删除：${filename} ？\n（删除后会重建向量索引）`)) return;

            uploadStatus.textContent = `正在删除 #${id}...`;
            try {
                const r = await fetch(`/docs/${id}`, { method: 'DELETE' });
                const j = await r.json();
                if (!r.ok) throw new Error(j.error || '删除失败');

                uploadStatus.textContent = `删除成功：#${id}（向量条目：${j.vector_count ?? '更新中'}）`;
                await refreshDocs();
            } catch (err) {
                uploadStatus.textContent = `删除失败：${err.message}`;
            }
        }

        function escapeHtml(str) {
            return (str || '').replace(/[&<>"']/g, (m) => ({
                '&': '&amp;', '<': '&lt;', '>': '&gt;', '"': '&quot;', "'": '&#039;'
            }[m]));
        }

        // LaTeX preprocessing
        function splitByFencedCode(text) {
            const parts = [];
            const re = /```[\s\S]*?```/g;
            let last = 0, m;
            while ((m = re.exec(text)) !== null) {
                if (m.index > last) parts.push({ type: 'text', value: text.slice(last, m.index) });
                parts.push({ type: 'code', value: m[0] });
                last = m.index + m[0].length;
            }
            if (last < text.length) parts.push({ type: 'text', value: text.slice(last) });
            return parts;
        }

        function normalizeLatexDelimitersOutsideCode(text) {
            if (!text) return '';
            return splitByFencedCode(text).map(p => {
                if (p.type === 'code') return p.value;
                let t = p.value;
                t = t.replace(/\\\[\s*/g, '\n$$\n');
                t = t.replace(/\s*\\\]/g, '\n$$\n');
                t = t.replace(/\\\(\s*/g, '$');
                t = t.replace(/\s*\\\)/g, '$');
                return t;
            }).join('');
        }

        function fixUnbalancedInlineDollars(text) {
            if (!text) return '';
            return splitByFencedCode(text).map(p => {
                if (p.type === 'code') return p.value;
                let t = p.value;
                const DDL = "__DDL__";
                t = t.replace(/\$\$/g, DDL);
                const positions = [];
                for (let i = 0; i < t.length; i++) {
                    if (t[i] === '$' && t[i - 1] !== '\\') positions.push(i);
                }
                if (positions.length % 2 === 1) {
                    const last = positions[positions.length - 1];
                    t = t.slice(0, last) + '\\$' + t.slice(last + 1);
                }
                t = t.replace(new RegExp(DDL, 'g'), '$$');
                return t;
            }).join('');
        }

        function renderMathSafe(rootEl, retries = 40, delayMs = 120) {
            if (!rootEl) return;
            requestAnimationFrame(() => {
                if (!window.renderMathInElement) {
                    if (retries <= 0) return;
                    setTimeout(() => renderMathSafe(rootEl, retries - 1, delayMs), delayMs);
                    return;
                }
                try {
                    window.renderMathInElement(rootEl, {
                        delimiters: [
                            { left: "$$", right: "$$", display: true },
                            { left: "$", right: "$", display: false },
                        ],
                        throwOnError: false,
                        ignoredTags: ["script", "noscript", "style", "textarea", "pre", "code"]
                    });
                } catch (e) {
                    if (retries > 0) setTimeout(() => renderMathSafe(rootEl, retries - 1, delayMs), delayMs);
                }
            });
        }

        function highlightCode(rootEl) {
            if (!rootEl) return;
            rootEl.querySelectorAll('pre code').forEach((block) => {
                hljs.highlightElement(block);
            });
        }

        function renderMarkdownInto(el, rawText, { finalizeMath = false } = {}) {
            let normalized = normalizeLatexDelimitersOutsideCode(rawText);
            normalized = fixUnbalancedInlineDollars(normalized);
            el.innerHTML = marked.parse(normalized);
            highlightCode(el);
            if (finalizeMath) {
                renderMathSafe(el);
            }
        }

        // SSE parsing
        function parseSSEEvents(buffer) {
            const events = [];
            const sepRe = /\r?\n\r?\n/;
            while (true) {
                const match = sepRe.exec(buffer);
                if (!match) break;
                const idx = match.index;
                const rawEvent = buffer.slice(0, idx);
                buffer = buffer.slice(idx + match[0].length);
                const lines = rawEvent.split(/\r?\n/);
                const dataLines = lines.filter(l => l.startsWith('data:'));
                if (dataLines.length) {
                    const dataStr = dataLines.map(l => l.replace(/^data:\s?/, '')).join('\n');
                    events.push(dataStr);
                }
            }
            return { events, buffer };
        }

        function flushSSEBuffer(buffer) {
            const trimmed = (buffer || '').trim();
            if (!trimmed) return [];
            const lines = trimmed.split(/\r?\n/);
            const dataLines = lines.filter(l => l.startsWith('data:'));
            if (!dataLines.length) return [];
            return [dataLines.map(l => l.replace(/^data:\s?/, '')).join('\n')];
        }

        let renderScheduled = false;
        function scheduleStreamRender(el, getText) {
            if (renderScheduled) return;
            renderScheduled = true;
            setTimeout(() => {
                renderScheduled = false;
                renderMarkdownInto(el, getText(), { finalizeMath: false });
                chatBox.scrollTop = chatBox.scrollHeight;
            }, 60);
        }

        uploadForm.onsubmit = async (e) => {
            e.preventDefault();
            const fd = new FormData(uploadForm);
            uploadStatus.textContent = '上传 & 解析中...';
            try {
                const r = await fetch('/upload', { method: 'POST', body: fd });
                const j = await r.json();
                if (!r.ok) throw new Error(j.error || '上传失败');
                uploadStatus.textContent = `完成：${j.filename} · chunks=${j.chunks}`;
                await refreshDocs();
            } catch (err) {
                uploadStatus.textContent = `失败：${err.message}`;
            }
        };

        async function loadPersonal() {
            const [p1, p2] = await Promise.all([
                fetch('/prefs').then(r => r.json()),
                fetch('/profile').then(r => r.json())
            ]);
            prefLanguage.value = p1.language || 'zh';
            prefTone.value = p1.tone || '';
            prefFormat.value = p1.format_hint || '';
            prefCite.value = p1.cite_style || '';
            memoryBox.value = p2.memory || '';
            personalStatus.textContent = '已刷新';
            setTimeout(() => personalStatus.textContent = '', 1200);
        }

        async function savePersonal() {
            personalStatus.textContent = '保存中...';
            await fetch('/prefs', {
                method: 'PUT',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({
                    language: prefLanguage.value.trim(),
                    tone: prefTone.value.trim(),
                    format_hint: prefFormat.value.trim(),
                    cite_style: prefCite.value.trim()
                })
            });
            await fetch('/profile', {
                method: 'PUT',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ memory: memoryBox.value })
            });
            personalStatus.textContent = '已保存';
            setTimeout(() => personalStatus.textContent = '', 1500);
        }

        document.getElementById('savePersonalBtn').onclick = (e) => { e.preventDefault(); savePersonal(); };
        document.getElementById('loadPersonalBtn').onclick = (e) => { e.preventDefault(); loadPersonal(); };

        async function sendMessage() {
            const msg = userInput.value.trim();
            if (!msg) return;

            const userDiv = createMessageElement('user');
            userDiv.querySelector('.markdown-body').innerText = msg;

            userInput.value = '';
            sendBtn.disabled = true;

            const aiDiv = createMessageElement('ai');
            const aiContentBody = aiDiv.querySelector('.markdown-body');
            const fileInfoDiv = aiDiv.querySelector('.file-info');
            const citeInfoDiv = aiDiv.querySelector('.cite-info');

            let fullText = "";
            let sseBuffer = "";
            let gotDone = false;

            fileInfoDiv.classList.add('hidden');
            citeInfoDiv.classList.add('hidden');
            citeInfoDiv.innerHTML = '';

            try {
                const response = await fetch('/chat', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        message: msg,
                        mode: currentMode,
                        use_rag: ragToggle.checked,
                        top_k: parseInt(topk.value || '6', 10)
                    })
                });

                if (!response.ok) throw new Error('网络响应错误');

                const reader = response.body.getReader();
                const decoder = new TextDecoder();

                const handleEvent = (evtStr) => {
                    let data;
                    try {
                        data = JSON.parse(evtStr);
                    } catch (e) {
                        return;
                    }

                    if (data.content) {
                        fullText += data.content;
                        scheduleStreamRender(aiContentBody, () => fullText);
                    }

                    if (data.error) {
                        fullText += `\n\n**错误：** ${data.error}`;
                        renderMarkdownInto(aiContentBody, fullText, { finalizeMath: false });
                    }

                    if (data.done) {
                        gotDone = true;
                        renderMarkdownInto(aiContentBody, fullText, { finalizeMath: true });

                        if (data.files && data.files.length > 0) {
                            fileInfoDiv.classList.remove('hidden');
                            const fileTags = data.files.map(f =>
                                `<span class="bg-emerald-500/20 text-emerald-300 text-xs px-2 py-1 rounded-lg mr-2">${escapeHtml(f)}</span>`
                            ).join('');
                            fileInfoDiv.innerHTML = `已保存文件: ${fileTags}`;
                        }

                        const citations = Array.isArray(data.citations) ? data.citations : [];
                        const retrieved = Array.isArray(data.retrieved) ? data.retrieved : [];

                        if (citations.length > 0) {
                            citeInfoDiv.classList.remove('hidden');
                            citeInfoDiv.innerHTML =
                                '<div class="font-semibold mb-3 text-slate-200">引用来源</div>' +
                                citations.map(c => `
                                    <div class="glass-panel-sm p-3 mb-2">
                                        <div class="tiny text-sky-400 font-semibold">
                                            ${escapeHtml(c.tag)} ${escapeHtml(c.filename)} @ ${escapeHtml(String(c.locator))}${c.score != null ? ` · score=${escapeHtml(String(c.score))}` : ''}
                                        </div>
                                        <div class="tiny text-slate-300 mt-1">${escapeHtml(c.snippet)}</div>
                                    </div>
                                `).join('');
                        } else if (retrieved.length > 0) {
                            citeInfoDiv.classList.remove('hidden');
                            citeInfoDiv.innerHTML =
                                '<div class="font-semibold mb-2 text-slate-200">检索到候选片段（未达到引用阈值）</div>' +
                                `<div class="tiny text-slate-500 mb-2">本次检索到的片段可能与问题不够贴合，但仍可参考。</div>` +
                                retrieved.map((c, idx) => `
                                    <div class="glass-panel-sm p-3 mb-2 opacity-70">
                                        <div class="tiny text-slate-400 font-semibold">
                                            [cand${idx+1}] ${escapeHtml(c.filename)} @ ${escapeHtml(String(c.locator))} · score=${escapeHtml(String(c.score))}
                                        </div>
                                        <div class="tiny text-slate-300 mt-1">${escapeHtml(c.snippet)}</div>
                                    </div>
                                `).join('');
                        }

                        chatBox.scrollTop = chatBox.scrollHeight;
                    }
                };

                while (true) {
                    const { done, value } = await reader.read();
                    if (done) break;

                    sseBuffer += decoder.decode(value, { stream: true });
                    const parsed = parseSSEEvents(sseBuffer);
                    sseBuffer = parsed.buffer;

                    for (const evt of parsed.events) {
                        handleEvent(evt);
                    }
                }

                const tailEvents = flushSSEBuffer(sseBuffer);
                for (const evt of tailEvents) handleEvent(evt);

                if (!gotDone) {
                    renderMarkdownInto(aiContentBody, fullText, { finalizeMath: true });
                }

            } catch (e) {
                console.error(e);
                aiContentBody.innerHTML = `<div class="text-red-400">连接中断或后端报错</div>`;
            } finally {
                sendBtn.disabled = false;
                chatBox.scrollTop = chatBox.scrollHeight;
            }
        }

        async function clearHistory() {
            if(!confirm("清空对话历史？")) return;
            await fetch('/clear', { method: 'POST' });
            chatBox.innerHTML = '<div class="ai-msg p-5 rounded-2xl"><div class="text-slate-200">对话历史已清空，已重置为普通对话模式。</div></div>';
            setMode('chat');
        }

        async function quitApp() {
            if(!confirm("确认退出应用？")) return;
            document.getElementById('status-tag').innerHTML = '<span class="status-dot bg-red-500 text-red-500"></span><span class="text-red-400 text-xs font-medium ml-2">已离线</span>';
            fetch('/quit', { method: 'POST' });
            const div = createMessageElement('ai');
            div.querySelector('.markdown-body').innerText = "后端进程已终止，请手动关闭窗口。";
        }

        (async () => {
            setMode('chat');
            await refreshDocs();
            await loadPersonal();
        })();
    </script>
</body>
</html>
