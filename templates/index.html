<!DOCTYPE html>
<html lang="zh">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>CyberCat RAG Demo</title>
    <script src="https://cdn.tailwindcss.com"></script>

    <!-- Markdown -->
    <script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>

    <!-- Code highlight -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.9.0/styles/github-dark.min.css">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.9.0/highlight.min.js"></script>

    <!-- âœ… KaTeX (Math) -->
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/katex@0.16.10/dist/katex.min.css">
    <!-- ä¿æŒä¸ deferï¼šè®© KaTeX å°½æ—©å¯ç”¨ -->
    <script src="https://cdn.jsdelivr.net/npm/katex@0.16.10/dist/katex.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/katex@0.16.10/dist/contrib/auto-render.min.js"></script>

    <style>
        .chat-container { height: calc(100vh - 330px); }
        .markdown-body pre { background: #1a1a1a; padding: 1rem; border-radius: 0.75rem; margin: 1rem 0; overflow-x: auto; }
        .user-msg { background: #2d3748; }
        .ai-msg { background: #111827; border: 1px solid #374151; }
        .btn-active { border-color: #60a5fa !important; background-color: #1e3a8a !important; box-shadow: 0 0 10px rgba(59, 130, 246, 0.35); }
        .panel { background: rgba(17,24,39,.7); border: 1px solid #374151; border-radius: 0.75rem; }
        .tiny { font-size: 12px; }

        /* âœ… KaTeX: è§£å†³è¶…é•¿å…¬å¼æº¢å‡º/éš¾çœ‹ */
        .katex { font-size: 1.05em; max-width: 100%; display: inline-block; overflow-x: auto; overflow-y: hidden; }
        .katex-display { overflow-x: auto; overflow-y: hidden; padding: 0.5rem 0; }
        .markdown-body p { overflow-wrap: anywhere; }
    </style>
</head>
<body class="bg-gray-900 text-gray-100 font-sans">
    <div class="max-w-6xl mx-auto p-4">
        <header class="flex flex-col md:flex-row md:justify-between md:items-center gap-2 mb-4 py-4 border-b border-gray-800">
            <div>
                <h1 class="text-2xl font-bold text-blue-400">CyberCat AI <span class="text-xs font-normal text-gray-500">RAG + Personalization Demo</span></h1>
                <div class="tiny text-gray-500 mt-1">ä¸Šä¼  PDF/DOCX ä½œä¸ºçŸ¥è¯†åº“ï¼Œå¼€å¯ RAG åå›ç­”ä¼šå¸¦å¼•ç”¨æ¥æºï¼›åå¥½ä¸è®°å¿†å¯æ§å¯ç¼–è¾‘ã€‚</div>
            </div>
            <div id="status-tag" class="text-green-500 text-xs flex items-center">
                <span class="w-2 h-2 bg-green-500 rounded-full mr-2"></span> åœ¨çº¿æ¨¡å¼: <span id="current-mode-display" class="ml-1 font-bold">æ™®é€šå¯¹è¯</span>
            </div>
        </header>

        <div class="grid grid-cols-1 lg:grid-cols-3 gap-4">
            <!-- Left: Knowledge base + Personalization -->
            <div class="space-y-4">
                <div class="panel p-4">
                    <div class="flex items-center justify-between mb-2">
                        <div class="font-semibold">ğŸ“š çŸ¥è¯†åº“</div>
                        <div class="tiny text-gray-400">å‘é‡æ¡ç›®: <span id="vec-count">0</span></div>
                    </div>

                    <form id="uploadForm" class="flex gap-2 items-center">
                        <label for="kbFile" class="tiny text-gray-300 whitespace-nowrap">é€‰æ‹©æ–‡ä»¶</label>
                        <input
                            id="kbFile"
                            type="file"
                            name="file"
                            accept=".pdf,.docx"
                            class="block w-full text-sm text-gray-300 file:mr-2 file:py-1 file:px-3 file:rounded file:border-0 file:text-sm file:bg-gray-700 file:text-gray-200 hover:file:bg-gray-600"
                        />
                        <button type="submit" class="bg-blue-600 hover:bg-blue-500 text-white px-3 py-2 rounded-lg text-sm transition">
                            ä¸Šä¼ 
                        </button>
                    </form>
                    <div id="uploadStatus" class="tiny text-gray-400 mt-2"></div>

                    <div class="mt-3 flex items-center justify-between">
                        <label class="flex items-center gap-2 tiny text-gray-200">
                            <input id="ragToggle" type="checkbox" class="accent-blue-500" checked />
                            ä½¿ç”¨çŸ¥è¯†åº“ï¼ˆRAGï¼‰
                        </label>
                        <div class="tiny text-gray-500">
                            <label for="topk" class="mr-2">topK:</label>
                            <input
                                id="topk"
                                type="number"
                                min="1"
                                max="12"
                                value="6"
                                class="w-14 bg-gray-800 border border-gray-700 rounded px-2 py-1 tiny"
                            >
                        </div>
                    </div>

                    <div class="mt-3">
                        <div class="tiny text-gray-400 mb-1">å·²ä¸Šä¼ æ–‡ä»¶</div>
                        <div id="docList" class="space-y-2 max-h-52 overflow-auto pr-1"></div>
                    </div>
                </div>

                <div class="panel p-4">
                    <div class="font-semibold mb-2">ğŸ§  ä¸ªäººåŒ–</div>

                    <div class="tiny text-gray-400 mb-1">åå¥½ï¼ˆä¼šæ³¨å…¥ç³»ç»Ÿæç¤ºè¯ï¼‰</div>
                    <div class="grid grid-cols-2 gap-2">
                        <input id="prefLanguage" class="bg-gray-800 border border-gray-700 rounded px-3 py-2 tiny" placeholder="language: zh/en">
                        <input id="prefTone" class="bg-gray-800 border border-gray-700 rounded px-3 py-2 tiny" placeholder="tone: ä¸“ä¸šä½†å¯çˆ±">
                    </div>
                    <textarea id="prefFormat" class="mt-2 w-full bg-gray-800 border border-gray-700 rounded px-3 py-2 tiny" rows="2" placeholder="format_hintï¼šä¾‹å¦‚ å…ˆç»“è®ºååˆ†ç‚¹ï¼Œæœ€åç»™ next steps"></textarea>
                    <textarea id="prefCite" class="mt-2 w-full bg-gray-800 border border-gray-700 rounded px-3 py-2 tiny" rows="2" placeholder="cite_styleï¼šä¾‹å¦‚ ä»…åœ¨å¼•ç”¨å­˜åœ¨æ—¶è¾“å‡º [1][2]"></textarea>

                    <div class="tiny text-gray-400 mt-3 mb-1">è®°å¿†ï¼ˆæ‰‹åŠ¨å¯æ§ï¼Œå¯éšæ—¶ä¿®æ”¹/æ¸…ç©ºï¼‰</div>
                    <textarea id="memoryBox" class="w-full bg-gray-800 border border-gray-700 rounded px-3 py-2 tiny" rows="4" placeholder="ä¾‹å¦‚ï¼šæˆ‘åœ¨åšä¸€ä¸ªå®‰å…¨å·¥å…·é¡¹ç›®ï¼›åå¥½ç”¨ä¸­æ–‡ï¼›å›ç­”è¦çŸ­ï¼›ç»™å¯æ‰§è¡Œæ­¥éª¤..."></textarea>

                    <div class="flex gap-2 mt-2">
                        <button id="savePersonalBtn" class="bg-emerald-600 hover:bg-emerald-500 text-white px-3 py-2 rounded-lg text-sm transition">ä¿å­˜</button>
                        <button id="loadPersonalBtn" class="bg-gray-700 hover:bg-gray-600 text-white px-3 py-2 rounded-lg text-sm transition">åˆ·æ–°</button>
                    </div>
                    <div id="personalStatus" class="tiny text-gray-400 mt-2"></div>
                </div>
            </div>

            <!-- Right: Chat -->
            <div class="lg:col-span-2">
                <div id="chat-box" class="chat-container overflow-y-auto mb-4 space-y-4 pr-2">
                    <div class="ai-msg p-4 rounded-lg">
                        ä½ å¥½ï¼ä¸Šä¼ ä½ çš„ PDF/DOCX å¹¶å¼€å¯ RAGï¼Œæˆ‘å°±å¯ä»¥â€œå¸¦å¼•ç”¨â€åœ°å›ç­”å•¦ï½
                        <div class="tiny text-gray-400 mt-2">æç¤ºï¼šè¿™æ˜¯ demoï¼Œæ²¡æœ‰åšç”¨æˆ·éš”ç¦»ï¼›æœ¬æœºå•äººä½¿ç”¨æ²¡é—®é¢˜ã€‚</div>
                    </div>
                </div>

                <div class="flex flex-wrap gap-2 mb-3">
                    <button id="btn-chat" onclick="setMode('chat')" class="bg-gray-800 border border-gray-600 hover:bg-gray-700 text-gray-300 px-4 py-2 rounded-lg text-sm transition flex items-center btn-active">
                        <span class="mr-1">ğŸ’¬</span> æ™®é€šå¯¹è¯
                    </button>
                    <button id="btn-c" onclick="setMode('c')" class="bg-gray-800 border border-gray-600 hover:bg-gray-700 text-gray-300 px-4 py-2 rounded-lg text-sm transition flex items-center">
                        <span class="mr-1">ğŸ“</span> C è¯­è¨€æ¨¡å¼
                    </button>
                    <button id="btn-python" onclick="setMode('python')" class="bg-gray-800 border border-gray-600 hover:bg-gray-700 text-gray-300 px-4 py-2 rounded-lg text-sm transition flex items-center">
                        <span class="mr-1">ğŸ</span> Python æ¨¡å¼
                    </button>
                    <button id="btn-java" onclick="setMode('java')" class="bg-gray-800 border border-gray-600 hover:bg-gray-700 text-gray-300 px-4 py-2 rounded-lg text-sm transition flex items-center">
                        <span class="mr-1">â˜•</span> Java æ¨¡å¼
                    </button>
                    <div class="border-l border-gray-800 mx-1"></div>
                    <button onclick="clearHistory()" class="bg-gray-800 border border-gray-600 hover:bg-red-900/40 text-gray-300 px-4 py-2 rounded-lg text-sm transition flex items-center">
                        <span class="mr-1">ğŸ§¹</span> Clear
                    </button>
                    <button onclick="quitApp()" class="bg-gray-800 border border-gray-600 hover:bg-red-700 text-gray-300 px-4 py-2 rounded-lg text-sm transition flex items-center">
                        <span class="mr-1">âŒ</span> Quit
                    </button>
                </div>

                <div class="relative">
                    <input type="text" id="user-input"
                        class="w-full bg-gray-800 border border-gray-700 rounded-xl px-4 py-4 pr-24 focus:outline-none focus:border-blue-500"
                        placeholder="æŒ‰å½“å‰æ¨¡å¼è¾“å…¥éœ€æ±‚..."
                        onkeyup="if(event.key==='Enter') sendMessage()">
                    <button id="send-btn" onclick="sendMessage()"
                        class="absolute right-2 top-2 bg-blue-600 hover:bg-blue-500 text-white px-6 py-2 rounded-lg transition">å‘é€</button>
                </div>
                <div class="tiny text-gray-500 mt-2">RAG å¼€å¯æ—¶ï¼šä¼šå…ˆæ£€ç´¢çŸ¥è¯†åº“ç‰‡æ®µï¼Œå†äº¤ç»™æ¨¡å‹å›ç­”ï¼Œå¹¶åœ¨æœ€åè¿”å›å¼•ç”¨æ¥æºå¡ç‰‡ã€‚</div>
            </div>
        </div>
    </div>

    <script>
        const chatBox = document.getElementById('chat-box');
        const userInput = document.getElementById('user-input');
        const sendBtn = document.getElementById('send-btn');
        const uploadForm = document.getElementById('uploadForm');
        const uploadStatus = document.getElementById('uploadStatus');
        const docList = document.getElementById('docList');
        const vecCount = document.getElementById('vec-count');

        const ragToggle = document.getElementById('ragToggle');
        const topk = document.getElementById('topk');

        const prefLanguage = document.getElementById('prefLanguage');
        const prefTone = document.getElementById('prefTone');
        const prefFormat = document.getElementById('prefFormat');
        const prefCite = document.getElementById('prefCite');
        const memoryBox = document.getElementById('memoryBox');
        const personalStatus = document.getElementById('personalStatus');

        let currentMode = 'chat';

        function setMode(mode) {
            currentMode = mode;
            updateModeUI();
            const modeNames = { 'chat': 'æ™®é€šå¯¹è¯', 'c': 'C è¯­è¨€ç¼–ç¨‹', 'python': 'Python ç¼–ç¨‹', 'java': 'Java ç¼–ç¨‹' };
            document.getElementById('current-mode-display').innerText = modeNames[mode];
        }

        function updateModeUI() {
            ['btn-chat', 'btn-c', 'btn-python', 'btn-java'].forEach(id => {
                const el = document.getElementById(id);
                if(el) el.classList.remove('btn-active');
            });
            const activeBtn = document.getElementById(`btn-${currentMode}`);
            if(activeBtn) activeBtn.classList.add('btn-active');
        }

        function createMessageElement(role) {
            const div = document.createElement('div');
            div.className = `p-4 rounded-lg ${role === 'user' ? 'user-msg ml-12' : 'ai-msg mr-12'}`;
            div.innerHTML = `
                <div class="text-xs text-gray-500 mb-1">${role === 'user' ? 'ä½ ' : 'çŒ«å¨˜åŠ©æ‰‹'}</div>
                <div class="markdown-body text-gray-200"></div>
                <div class="file-info mt-3 pt-2 border-t border-gray-700 text-sm text-gray-400 hidden"></div>
                <div class="cite-info mt-3 pt-2 border-t border-gray-700 text-sm text-gray-300 hidden"></div>
            `;
            chatBox.appendChild(div);
            chatBox.scrollTop = chatBox.scrollHeight;
            return div;
        }

        async function refreshDocs() {
            const r = await fetch('/docs');
            const j = await r.json();
            vecCount.textContent = j.vector_count ?? 0;

            const docs = j.documents || [];
            if (docs.length === 0) {
                docList.innerHTML = '<div class="tiny text-gray-500">è¿˜æ²¡æœ‰ä¸Šä¼ ä»»ä½•æ–‡ä»¶</div>';
                return;
            }
            docList.innerHTML = docs.map(d => `
                <div class="bg-gray-800/60 border border-gray-700 rounded-lg px-3 py-2 flex items-center justify-between gap-3">
                    <div class="min-w-0">
                        <div class="text-sm text-gray-200 truncate">${escapeHtml(d.filename)}</div>
                        <div class="tiny text-gray-500">#${d.id} Â· ${escapeHtml(d.created_at)}</div>
                    </div>
                    <button
                        class="shrink-0 bg-red-700/70 hover:bg-red-600 text-white tiny px-2 py-1 rounded"
                        onclick="deleteDoc(${d.id}, '${escapeHtml(d.filename)}')"
                        title="åˆ é™¤è¿™ä¸ªæ–‡ä»¶ï¼ˆä¼šé‡å»ºç´¢å¼•ï¼‰"
                    >ğŸ—‘ åˆ é™¤</button>
                </div>
            `).join('');
        }

        async function deleteDoc(id, filename) {
            if (!confirm(`ç¡®è®¤åˆ é™¤ï¼š${filename} ï¼Ÿ\nï¼ˆåˆ é™¤åä¼šé‡å»ºå‘é‡ç´¢å¼•ï¼Œdemo ä¸­è¿™æ˜¯æ­£å¸¸æ“ä½œï¼‰`)) return;

            uploadStatus.textContent = `æ­£åœ¨åˆ é™¤ #${id}...`;
            try {
                const r = await fetch(`/docs/${id}`, { method: 'DELETE' });
                const j = await r.json();
                if (!r.ok) throw new Error(j.error || 'åˆ é™¤å¤±è´¥');

                uploadStatus.textContent = `åˆ é™¤æˆåŠŸï¼š#${id}ï¼ˆå‘é‡æ¡ç›®ï¼š${j.vector_count ?? 'æ›´æ–°ä¸­'}ï¼‰`;
                await refreshDocs();
            } catch (err) {
                uploadStatus.textContent = `åˆ é™¤å¤±è´¥ï¼š${err.message}`;
            }
        }

        function escapeHtml(str) {
            return (str || '').replace(/[&<>"']/g, (m) => ({
                '&': '&amp;', '<': '&lt;', '>': '&gt;', '"': '&quot;', "'": '&#039;'
            }[m]));
        }

        // -----------------------------
        // âœ… LaTeX é¢„å¤„ç†ï¼šè·³è¿‡ä»£ç å— + ä¿®å¤ä¸æˆå¯¹çš„å• $
        // -----------------------------
        function splitByFencedCode(text) {
            const parts = [];
            const re = /```[\s\S]*?```/g;
            let last = 0, m;
            while ((m = re.exec(text)) !== null) {
                if (m.index > last) parts.push({ type: 'text', value: text.slice(last, m.index) });
                parts.push({ type: 'code', value: m[0] });
                last = m.index + m[0].length;
            }
            if (last < text.length) parts.push({ type: 'text', value: text.slice(last) });
            return parts;
        }

        function normalizeLatexDelimitersOutsideCode(text) {
            if (!text) return '';
            return splitByFencedCode(text).map(p => {
                if (p.type === 'code') return p.value;

                let t = p.value;

                // \[ \] -> $$ $$
                t = t.replace(/\\\[\s*/g, '\n$$\n');
                t = t.replace(/\s*\\\]/g, '\n$$\n');

                // \( \) -> $ $
                t = t.replace(/\\\(\s*/g, '$');
                t = t.replace(/\s*\\\)/g, '$');

                return t;
            }).join('');
        }

        // âœ… å…³é”®ä¿®å¤ï¼šå¦‚æœå‡ºç°å¥‡æ•°ä¸ªå• $ï¼ˆæ’é™¤ $$ï¼‰ï¼Œå°±æŠŠæœ€åä¸€ä¸ªå• $ å˜æˆ \$ï¼Œé¿å… KaTeX æ•´æ®µå¤±æ•ˆ
        function fixUnbalancedInlineDollars(text) {
            if (!text) return '';

            return splitByFencedCode(text).map(p => {
                if (p.type === 'code') return p.value;

                let t = p.value;

                // æš‚å­˜ $$ï¼Œé¿å…å¹²æ‰°å• $ è®¡æ•°
                const DDL = "__DDL__";
                t = t.replace(/\$\$/g, DDL);

                // æ‰¾â€œå• $â€ï¼šä¸æ”¯æŒè½¬ä¹‰ \$
                const positions = [];
                for (let i = 0; i < t.length; i++) {
                    if (t[i] === '$' && t[i - 1] !== '\\') positions.push(i);
                }

                if (positions.length % 2 === 1) {
                    const last = positions[positions.length - 1];
                    t = t.slice(0, last) + '\\$' + t.slice(last + 1);
                }

                // è¿˜åŸ $$
                t = t.replace(new RegExp(DDL, 'g'), '$$');
                return t;
            }).join('');
        }

        // -----------------------------
        // âœ… KaTeX æ¸²æŸ“ï¼šæ›´ç¨³çš„ç­‰å¾… + æ›´é•¿é‡è¯• + ä¸‹ä¸€å¸§æ‰§è¡Œ
        // -----------------------------
        function renderMathSafe(rootEl, retries = 40, delayMs = 120) {
            if (!rootEl) return;

            // æ”¾åˆ°ä¸‹ä¸€å¸§ï¼šç¡®ä¿ marked æ¸²æŸ“åçš„ DOM å·²ç»è½åœ°
            requestAnimationFrame(() => {
                if (!window.renderMathInElement) {
                    if (retries <= 0) return;
                    setTimeout(() => renderMathSafe(rootEl, retries - 1, delayMs), delayMs);
                    return;
                }
                try {
                    window.renderMathInElement(rootEl, {
                        delimiters: [
                            { left: "$$", right: "$$", display: true },
                            { left: "$", right: "$", display: false },
                        ],
                        throwOnError: false,
                        ignoredTags: ["script", "noscript", "style", "textarea", "pre", "code"]
                    });
                } catch (e) {
                    if (retries > 0) setTimeout(() => renderMathSafe(rootEl, retries - 1, delayMs), delayMs);
                }
            });
        }

        function highlightCode(rootEl) {
            if (!rootEl) return;
            rootEl.querySelectorAll('pre code').forEach((block) => {
                hljs.highlightElement(block);
            });
        }

        function renderMarkdownInto(el, rawText, { finalizeMath = false } = {}) {
            let normalized = normalizeLatexDelimitersOutsideCode(rawText);
            normalized = fixUnbalancedInlineDollars(normalized);

            el.innerHTML = marked.parse(normalized);
            highlightCode(el);

            if (finalizeMath) {
                renderMathSafe(el);
            }
        }

        // -----------------------------
        // âœ… SSE è§£æï¼šæ”¯æŒ \n\n ä¸ \r\n\r\nï¼›å¹¶æä¾› flush æœºåˆ¶
        // -----------------------------
        function parseSSEEvents(buffer) {
            const events = [];

            // å…¼å®¹ \n\n å’Œ \r\n\r\n
            const sepRe = /\r?\n\r?\n/;

            while (true) {
                const match = sepRe.exec(buffer);
                if (!match) break;

                const idx = match.index;
                const rawEvent = buffer.slice(0, idx);
                buffer = buffer.slice(idx + match[0].length);

                const lines = rawEvent.split(/\r?\n/);
                const dataLines = lines.filter(l => l.startsWith('data:'));
                if (dataLines.length) {
                    const dataStr = dataLines.map(l => l.replace(/^data:\s?/, '')).join('\n');
                    events.push(dataStr);
                }
            }

            return { events, buffer };
        }

        // âœ… flushï¼šæµç»“æŸæ—¶æŠŠæ®‹ç•™ buffer å½“æˆä¸€ä¸ª event å†è§£æä¸€æ¬¡ï¼ˆé˜²æ­¢ done ä¸¢å¤±ï¼‰
        function flushSSEBuffer(buffer) {
            const trimmed = (buffer || '').trim();
            if (!trimmed) return [];

            const lines = trimmed.split(/\r?\n/);
            const dataLines = lines.filter(l => l.startsWith('data:'));
            if (!dataLines.length) return [];

            return [dataLines.map(l => l.replace(/^data:\s?/, '')).join('\n')];
        }

        // æµå¼æ¸²æŸ“èŠ‚æµï¼ˆå…¨å±€ single-flightï¼›send æŒ‰é’®ç¦ç”¨æ‰€ä»¥å¤Ÿç”¨ï¼‰
        let renderScheduled = false;
        function scheduleStreamRender(el, getText) {
            if (renderScheduled) return;
            renderScheduled = true;
            setTimeout(() => {
                renderScheduled = false;
                renderMarkdownInto(el, getText(), { finalizeMath: false });
                chatBox.scrollTop = chatBox.scrollHeight;
            }, 60);
        }

        uploadForm.onsubmit = async (e) => {
            e.preventDefault();
            const fd = new FormData(uploadForm);
            uploadStatus.textContent = 'ä¸Šä¼  & è§£æ & å»ºåº“ä¸­...';
            try {
                const r = await fetch('/upload', { method: 'POST', body: fd });
                const j = await r.json();
                if (!r.ok) throw new Error(j.error || 'ä¸Šä¼ å¤±è´¥');
                uploadStatus.textContent = `å®Œæˆï¼š${j.filename} Â· chunks=${j.chunks}`;
                await refreshDocs();
            } catch (err) {
                uploadStatus.textContent = `å¤±è´¥ï¼š${err.message}`;
            }
        };

        async function loadPersonal() {
            const [p1, p2] = await Promise.all([
                fetch('/prefs').then(r => r.json()),
                fetch('/profile').then(r => r.json())
            ]);
            prefLanguage.value = p1.language || 'zh';
            prefTone.value = p1.tone || '';
            prefFormat.value = p1.format_hint || '';
            prefCite.value = p1.cite_style || '';
            memoryBox.value = p2.memory || '';
            personalStatus.textContent = 'å·²åˆ·æ–°';
            setTimeout(() => personalStatus.textContent = '', 1200);
        }

        async function savePersonal() {
            personalStatus.textContent = 'ä¿å­˜ä¸­...';
            await fetch('/prefs', {
                method: 'PUT',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({
                    language: prefLanguage.value.trim(),
                    tone: prefTone.value.trim(),
                    format_hint: prefFormat.value.trim(),
                    cite_style: prefCite.value.trim()
                })
            });
            await fetch('/profile', {
                method: 'PUT',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ memory: memoryBox.value })
            });
            personalStatus.textContent = 'å·²ä¿å­˜ âœ…';
            setTimeout(() => personalStatus.textContent = '', 1500);
        }

        document.getElementById('savePersonalBtn').onclick = (e) => { e.preventDefault(); savePersonal(); };
        document.getElementById('loadPersonalBtn').onclick = (e) => { e.preventDefault(); loadPersonal(); };

        async function sendMessage() {
            const msg = userInput.value.trim();
            if (!msg) return;

            const userDiv = createMessageElement('user');
            userDiv.querySelector('.markdown-body').innerText = msg;

            userInput.value = '';
            sendBtn.disabled = true;

            const aiDiv = createMessageElement('ai');
            const aiContentBody = aiDiv.querySelector('.markdown-body');
            const fileInfoDiv = aiDiv.querySelector('.file-info');
            const citeInfoDiv = aiDiv.querySelector('.cite-info');

            let fullText = "";
            let sseBuffer = "";
            let gotDone = false; // âœ… è®°å½•æ˜¯å¦çœŸçš„æ”¶åˆ° done

            fileInfoDiv.classList.add('hidden');
            citeInfoDiv.classList.add('hidden');
            citeInfoDiv.innerHTML = '';

            try {
                const response = await fetch('/chat', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        message: msg,
                        mode: currentMode,
                        use_rag: ragToggle.checked,
                        top_k: parseInt(topk.value || '6', 10)
                    })
                });

                if (!response.ok) throw new Error('ç½‘ç»œå“åº”é”™è¯¯');

                const reader = response.body.getReader();
                const decoder = new TextDecoder();

                const handleEvent = (evtStr) => {
                    let data;
                    try {
                        data = JSON.parse(evtStr);
                    } catch (e) {
                        return;
                    }

                    if (data.content) {
                        fullText += data.content;
                        scheduleStreamRender(aiContentBody, () => fullText);
                    }

                    if (data.error) {
                        fullText += `\n\n**é”™è¯¯ï¼š** ${data.error}`;
                        renderMarkdownInto(aiContentBody, fullText, { finalizeMath: false });
                    }

                    if (data.done) {
                        gotDone = true;

                        // âœ… doneï¼šæœ€ç»ˆæ¸²æŸ“ï¼ˆå«æ•°å­¦ï¼‰
                        renderMarkdownInto(aiContentBody, fullText, { finalizeMath: true });

                        if (data.files && data.files.length > 0) {
                            fileInfoDiv.classList.remove('hidden');
                            const fileTags = data.files.map(f =>
                                `<span class="bg-emerald-900 text-emerald-200 text-xs px-2 py-1 rounded mr-2">${escapeHtml(f)}</span>`
                            ).join('');
                            fileInfoDiv.innerHTML = `å·²ä¿å­˜æ–‡ä»¶: ${fileTags}`;
                        }

                        const citations = Array.isArray(data.citations) ? data.citations : [];
                        const retrieved = Array.isArray(data.retrieved) ? data.retrieved : [];

                        if (citations.length > 0) {
                            citeInfoDiv.classList.remove('hidden');
                            citeInfoDiv.innerHTML =
                                '<div class="font-semibold mb-2">å¼•ç”¨æ¥æº</div>' +
                                citations.map(c => `
                                    <div class="bg-gray-800/60 border border-gray-700 rounded-lg p-3 mb-2">
                                        <div class="tiny text-blue-300 font-semibold">
                                            ${escapeHtml(c.tag)} ${escapeHtml(c.filename)} @ ${escapeHtml(String(c.locator))}${c.score != null ? ` Â· score=${escapeHtml(String(c.score))}` : ''}
                                        </div>
                                        <div class="tiny text-gray-200 mt-1">${escapeHtml(c.snippet)}</div>
                                    </div>
                                `).join('');
                        } else if (retrieved.length > 0) {
                            citeInfoDiv.classList.remove('hidden');
                            citeInfoDiv.innerHTML =
                                '<div class="font-semibold mb-2">æ£€ç´¢åˆ°å€™é€‰ç‰‡æ®µï¼ˆæœªè¾¾åˆ°å¼•ç”¨é˜ˆå€¼ï¼‰</div>' +
                                `<div class="tiny text-gray-400 mb-2">è¯´æ˜ï¼šæœ¬æ¬¡æ£€ç´¢åˆ°çš„ç‰‡æ®µå¯èƒ½ä¸é—®é¢˜ä¸å¤Ÿè´´åˆï¼Œæ‰€ä»¥æ²¡æœ‰ä½œä¸ºâ€œå¼•ç”¨â€æ’å…¥å›ç­”ï¼Œä½†ä½ ä»å¯å‚è€ƒã€‚</div>` +
                                retrieved.map((c, idx) => `
                                    <div class="bg-gray-800/40 border border-gray-700 rounded-lg p-3 mb-2">
                                        <div class="tiny text-gray-300 font-semibold">
                                            [cand${idx+1}] ${escapeHtml(c.filename)} @ ${escapeHtml(String(c.locator))} Â· score=${escapeHtml(String(c.score))}
                                        </div>
                                        <div class="tiny text-gray-200 mt-1">${escapeHtml(c.snippet)}</div>
                                    </div>
                                `).join('');
                        }

                        chatBox.scrollTop = chatBox.scrollHeight;
                    }
                };

                while (true) {
                    const { done, value } = await reader.read();
                    if (done) break;

                    sseBuffer += decoder.decode(value, { stream: true });
                    const parsed = parseSSEEvents(sseBuffer);
                    sseBuffer = parsed.buffer;

                    for (const evt of parsed.events) {
                        handleEvent(evt);
                    }
                }

                // âœ… å…³é”®ä¿®å¤ï¼šæµç»“æŸå flush ä¸€æ¬¡æ®‹ç•™ bufferï¼ˆé˜²æ­¢æœ€åçš„ done æ²¡æœ‰ \n\nï¼‰
                const tailEvents = flushSSEBuffer(sseBuffer);
                for (const evt of tailEvents) handleEvent(evt);

                // âœ… å…œåº•ï¼šå¦‚æœåç«¯æ²¡å‘ doneï¼Œè‡³å°‘ä¹Ÿåšä¸€æ¬¡ finalizeï¼ˆä¿è¯ KaTeX ä¸ä¼šâ€œå¶å‘æ°¸è¿œä¸æ¸²æŸ“â€ï¼‰
                if (!gotDone) {
                    renderMarkdownInto(aiContentBody, fullText, { finalizeMath: true });
                }

            } catch (e) {
                console.error(e);
                aiContentBody.innerHTML = `<div class="text-red-500">è¿æ¥ä¸­æ–­æˆ–åç«¯æŠ¥é”™</div>`;
            } finally {
                sendBtn.disabled = false;
                chatBox.scrollTop = chatBox.scrollHeight;
            }
        }

        async function clearHistory() {
            if(!confirm("æ¸…ç©ºå†å²ï¼Ÿ")) return;
            await fetch('/clear', { method: 'POST' });
            chatBox.innerHTML = '<div class="ai-msg p-4 rounded-lg">å¯¹è¯å†å²å·²æ¸…ç©ºã€‚å·²é‡ç½®ä¸ºæ™®é€šå¯¹è¯ã€‚</div>';
            setMode('chat');
        }

        async function quitApp() {
            if(!confirm("é€€å‡ºåº”ç”¨ï¼Ÿ")) return;
            document.getElementById('status-tag').innerHTML = '<span class="w-2 h-2 bg-red-500 rounded-full mr-2"></span> æœåŠ¡å·²å…³é—­';
            fetch('/quit', { method: 'POST' });
            const div = createMessageElement('ai');
            div.querySelector('.markdown-body').innerText = "åç«¯è¿›ç¨‹å·²ç»ˆæ­¢ï¼Œè¯·æ‰‹åŠ¨å…³é—­çª—å£ã€‚";
        }

        (async () => {
            setMode('chat');
            await refreshDocs();
            await loadPersonal();
        })();
    </script>
</body>
</html>
